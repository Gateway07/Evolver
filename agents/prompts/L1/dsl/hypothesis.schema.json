{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.local/schemas/hypothesis.schema.json",
  "title": "Hypothesis DSL",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "hypothesis_id",
    "type",
    "axioms",
    "metric",
    "groups",
    "stratification",
    "claim",
    "evaluation"
  ],
  "properties": {
    "schema_version": { "type": "string", "pattern": "^[0-9]+\\.[0-9]+$" },
    "hypothesis_id": { "type": "string", "minLength": 1, "maxLength": 128 },
    "type": {
      "type": "string",
      "enum": ["DIFF_RATE", "RATE_THRESHOLD", "RATIO", "MONOTONIC_TREND", "RANK_ORDER", "MULTI_GROUP"]
    },
    "axioms": {
      "type": "array",
      "minItems": 1,
      "items": { "type": "string", "maxLength": 64 }
    },
    "scope": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "app_version": { "type": "string", "maxLength": 128 },
        "index_build_id": { "type": "string", "maxLength": 128 },
        "locale": { "type": "string", "maxLength": 64 },
        "notes": { "type": "string", "maxLength": 4000 }
      }
    },
    "feature_family": { "type": "string", "maxLength": 128 },
    "metric": {
      "type": "string",
      "enum": [
        "notFoundRate",
        "foundRate",
        "failedRate",
        "partialFoundRate",
        "totalDurationMs",
        "searchDurationMs",
        "totalBytes"
      ]
    },
    "groups": {
      "type": "array",
      "minItems": 1,
      "maxItems": 8,
      "items": { "$ref": "group_definition.schema.json" }
    },
    "group_roles": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "treatment": { "type": "string" },
        "control": { "type": "string" },
        "baseline": { "type": "string" },
        "comparators": { "type": "array", "items": { "type": "string" } }
      }
    },
    "stratification": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stratify_by"],
      "properties": {
        "stratify_by": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "pattern": "^[A-Za-z_][A-Za-z0-9_]*$" }
        },
        "split_policy": { "type": "object", "additionalProperties": true },
        "control_protocol": { "type": "object", "additionalProperties": true }
      }
    },
    "claim": {
      "type": "object",
      "additionalProperties": false,
      "required": ["confidence_level"],
      "properties": {
        "compare": {
          "type": "object",
          "additionalProperties": false,
          "required": ["group_a", "group_b"],
          "properties": {
            "group_a": { "type": "string" },
            "group_b": { "type": "string" }
          }
        },
        "delta_min": { "type": "number" },
        "delta_max": { "type": "number" },
        "rate_min": { "type": "number", "minimum": 0, "maximum": 1 },
        "rate_max": { "type": "number", "minimum": 0, "maximum": 1 },
        "confidence_level": { "type": "number", "minimum": 0.5, "maximum": 0.999, "default": 0.95 },
        "notes": { "type": "string", "maxLength": 4000 }
      }
    },
    "evaluation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["effect_size", "ci", "reproducibility"],
      "properties": {
        "effect_size": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["difference_of_proportions", "ratio_of_proportions", "odds_ratio", "trend_slope"]
            },
            "definition": { "type": "string", "maxLength": 4000 }
          }
        },
        "ci": {
          "type": "object",
          "additionalProperties": false,
          "required": ["method"],
          "properties": {
            "method": {
              "type": "string",
              "enum": ["bootstrap_by_strata", "wilson_score", "normal_approx", "clopper_pearson", "custom"]
            },
            "bootstrap": {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "resamples": { "type": "integer", "minimum": 100, "maximum": 20000, "default": 2000 },
                "seed": { "type": "integer" }
              }
            },
            "notes": { "type": "string", "maxLength": 4000 }
          }
        },
        "reproducibility": {
          "type": "object",
          "additionalProperties": false,
          "required": ["repeat_runs"],
          "properties": {
            "repeat_runs": { "type": "integer", "minimum": 1, "maximum": 50 },
            "accept_if_ci_supports_claim": { "type": "boolean", "default": true },
            "notes": { "type": "string", "maxLength": 4000 }
          }
        },
        "acceptance_gate": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "require_novelty": { "type": "boolean", "default": false },
            "novelty_kind": {
              "type": "array",
              "items": { "type": "string", "enum": ["reason_family", "feature_bin", "region"] }
            },
            "notes": { "type": "string", "maxLength": 4000 }
          }
        }
      }
    },
    "expected_effect": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "direction": { "type": "string", "enum": ["increase", "decrease", "no_change", "unknown"] },
        "min_effect_size": { "type": "number" },
        "notes": { "type": "string", "maxLength": 2000 }
      }
    },
    "signatures": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "hypothesis_signature": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
      }
    }
  }
}
